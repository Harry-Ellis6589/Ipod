<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>iPod â€” Spotify Controller (single-file v5)</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PWA manifest (data URI) -->
  <link rel="manifest" href="data:application/json;charset=utf-8,%7B%22name%22%3A%22iPod%20for%20Spotify%22%2C%22short_name%22%3A%22iPod%22%2C%22start_url%22%3A%22.%2F%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23D9DEE9%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage%2Fsvg%2Bxml%3Butf8%2C%3Csvg%20xmlns%3D%5C'%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%5C'%20width%3D%22192%22%20height%3D%22192%22%3E%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20fill%3D%22%23D9DEE9%22%2F%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2255%25%22%20font-size%3D%2240%22%20text-anchor%3D%22middle%22%20fill%3D%22%23033%22%3EiPod%3C%2Ftext%3E%3C%2Fsvg%3E%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%7D%2C%7B%22src%22%3A%22data%3Aimage%2Fsvg%2Bxml%3Butf8%2C%3Csvg%20xmlns%3D%5C'%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%5C'%20width%3D%22512%22%20height%3D%22512%22%3E%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20fill%3D%22%23D9DEE9%22%2F%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2255%25%22%20font-size%3D%2276%22%20text-anchor%3D%22middle%22%20fill%3D%22%23033%22%3EiPod%3C%2Ftext%3E%3C%2Fsvg%3E%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%7D%5D%7D" />

  <!-- iOS meta -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="iPod" />

  <style>
    /* Base look */
    :root { --ipod-width: min(420px, 92vw); --ipod-aspect: 9/16; }
    body { margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center; background: radial-gradient(ellipse at top left,#071428 0%, #02060b 70%); font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    .ipod { width: var(--ipod-width); max-width:420px; aspect-ratio: var(--ipod-aspect); border-radius: 28px; padding: 14px; display:flex; flex-direction:column; align-items:center; gap:10px; box-shadow: 0 8px 40px rgba(2,6,11,0.7); transition: background .18s, box-shadow .18s; }
    .ipod-inner { width:100%; height:100%; border-radius: 20px; padding:12px; box-shadow: inset 0 6px 28px rgba(0,0,0,0.4); display:flex; flex-direction:column; gap:10px; background: linear-gradient(#dfe6ec,#d2d8de); }
    .screen { height:36%; background: linear-gradient(#0b1220,#071322); width:100%; border-radius:12px; color:#e6eef6; padding:10px; box-sizing:border-box; position:relative; overflow:hidden; }
    .screen-top { display:flex; justify-content:space-between; align-items:center; font-size:12px; color: #cbd5e1; }
    .screen-body { margin-top:8px; height: calc(100% - 46px); overflow:hidden; }
    .screen-footer { font-size:11px; color:#94a3b8; margin-top:6px; }

    .wheel { height: 44%; display:flex; align-items:center; justify-content:center; width:100%; }
    .wheel-ring { width:72%; aspect-ratio:1/1; border-radius:999px; background: linear-gradient(#e6edf2,#cfd7df); position:relative; display:flex; align-items:center; justify-content:center; box-shadow: inset 0 -8px 20px rgba(255,255,255,0.06); touch-action:none; user-select:none; }
    .wheel-label { position:absolute; font-size:12px; color:#0b1220; user-select:none; pointer-events:none; }
    #menu-btn { top:8px; left: 50%; transform: translateX(-50%); }
    #prev-btn { left:10px; top:50%; transform: translateY(-50%); }
    #next-btn { right:10px; top:50%; transform: translateY(-50%); }
    #play-btn { bottom:8px; left:50%; transform: translateX(-50%); }
    .center-btn { width:28%; aspect-ratio:1/1; border-radius:999px; background: linear-gradient(#b9c7d4,#9eabb8); display:flex; align-items:center; justify-content:center; font-weight:700; box-shadow: 0 6px 18px rgba(0,0,0,0.35); }
    .pressed { transform: scale(0.96); transition: transform .08s ease; }

    /* Themes */
    .theme-classic .ipod-inner { background: linear-gradient(#dfe6ec,#d2d8de); }
    .theme-classic .wheel-ring { background: linear-gradient(#e6edf2,#cfd7df); }
    .theme-black .ipod-inner { background: linear-gradient(#1f2937,#111827); }
    .theme-black .wheel-ring { background: linear-gradient(#374151,#111827); }
    .theme-mini-blue .ipod-inner { background: linear-gradient(#e8f2ff,#d6e9ff); }
    .theme-mini-blue .wheel-ring { background: linear-gradient(#cfe6ff,#a8d6ff); }

    /* Boot screen */
    .boot-screen { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background: rgba(2,6,11,0.95); z-index:50; color:#e6eef6; flex-direction:column; gap:8px; font-weight:700; }

    /* Volume overlay */
    .volume-overlay{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); background: rgba(3,7,18,0.9); padding:10px 14px; border-radius:12px; z-index:40; }

    /* Status bar */
    .status-bar { position:absolute; top:8px; left:12px; right:12px; display:flex; justify-content:space-between; align-items:center; color:#cbd5e1; font-size:12px; pointer-events:none; z-index:60; }

    /* Misc */
    .list-item { padding:8px; border-radius:6px; }
    .selected { background: rgba(255,255,255,0.04); }
    .loading { color:#cbd5e1; font-style:italic; }
    .muted { color:#8b98a9; }
    img.album { border-radius:8px; object-fit:cover; }

    /* small-screen tweak */
    @media (max-width: 380px) {
      .ipod { padding:10px; }
      .center-btn { width:32%; }
    }
  </style>
</head>
<body>
  <div id="appRoot" class="ipod theme-classic">
    <div class="ipod-inner relative" id="ipodInner">

      <div class="status-bar" id="statusBar">
        <div id="clock">--:--</div>
        <div id="battery">ðŸ”‹</div>
      </div>

      <!-- Boot screen overlay -->
      <div id="bootScreen" class="boot-screen hidden">
        <div style="font-size:20px">iPod</div>
        <div style="font-size:12px" class="muted">Do not disconnect</div>
      </div>

      <!-- Screen -->
      <div id="screen" class="screen">
        <div class="screen-top">
          <div id="appTitle" class="font-semibold">Spotify</div>
          <div id="screenStatus" class="text-amber-300">Not logged in</div>
        </div>

        <div id="screenBody" class="screen-body">
          <!-- dynamic content here -->
        </div>

        <div class="screen-footer">
          <span id="screenHint">Use the wheel â€¢ Center = Select</span>
        </div>

      </div>

      <!-- Wheel -->
      <div class="wheel">
        <div id="wheel" class="wheel-ring">
          <div id="menuBtn" class="wheel-label" style="top:10px" aria-hidden>MENU</div>
          <div id="prevBtn" class="wheel-label" style="left:12px" aria-hidden>â—€</div>
          <div id="nextBtn" class="wheel-label" style="right:12px" aria-hidden>â–¶</div>
          <div id="playBtn" class="wheel-label" style="bottom:10px" aria-hidden>â–¶/â–®â–®</div>
          <div id="centerBtn" class="center-btn" role="button" tabindex="0">OK</div>
        </div>
      </div>

      <div style="text-align:center;font-size:11px;color:#64748b;margin-top:6px">Single-file PWA Â· Tailwind Â· Vanilla JS Â· v5</div>
    </div>
  </div>

  <!-- tiny tick audio (very quiet) -->
  <audio id="tickAudio" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=" preload="auto"></audio>

  <script>
  /*****************************************************************
   * iPod Spotify Controller â€” single-file (v5)
   * - PKCE Authorization Code Flow
   * - Playlists / Liked / Play / Devices / Search / Settings
   * - Themes, wheel sensitivity, feedback, PWA service worker & manifest
   * - Offline cache for shell and recent metadata
   *
   * IMPORTANT: Set CLIENT_ID and make sure REDIRECT_URI is added to your
   * Spotify app's Redirect URIs in the Spotify Developer Dashboard.
   *****************************************************************/

  // ---------- CONFIG ----------
  const CLIENT_ID = '105219b481564acabe23262bdac8ea2d';
  // default redirect URI (change if you host elsewhere)
  const REDIRECT_URI = 'https://harry-ellis6589.github.io/Ipod/';

  const SCOPES = [
    'user-read-playback-state',
    'user-modify-playback-state',
    'user-read-currently-playing',
    'playlist-read-private',
    'playlist-read-collaborative',
    'user-library-read',
    'user-read-private',
    'user-read-email'
  ].join(' ');

  // ---------- STATE ----------
  const ScreenBody = document.getElementById('screenBody');
  const screenStatus = document.getElementById('screenStatus');
  const bootScreen = document.getElementById('bootScreen');
  const statusBarClock = document.getElementById('clock');
  const batteryEl = document.getElementById('battery');
  const ipodRoot = document.getElementById('appRoot');
  const tickAudio = document.getElementById('tickAudio');

  let screenStack = []; // array of {renderFn, meta}
  let settings = {
    theme: localStorage.getItem('ipod_theme') || 'classic',
    sensitivity: localStorage.getItem('ipod_sensitivity') || 'medium',
    feedback: localStorage.getItem('ipod_feedback') === 'true' ? true : true
  };

  const SENS_MAP = { low: 20, medium: 12, high: 8 };
  let SCROLL_STEP_ANGLE = SENS_MAP[settings.sensitivity] || 12;

  let listState = { currentList: [], selectedIndex: 0, nextUrl: null };

  // ---------- Utilities ----------
  function qsParse(qs) {
    const p = new URLSearchParams(qs.replace(/^\?/, ''));
    const out = {};
    for (const [k,v] of p) out[k]=v;
    return out;
  }
  function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function setStatus(text, cls='text-amber-300'){ screenStatus.textContent = text; screenStatus.className = cls; }
  function showError(msg){ renderScreen(`<div class="p-3 text-red-300 text-sm">Error: ${escapeHtml(String(msg))}</div>`); setStatus('Error','text-red-300'); }

  // ---------- PKCE helpers ----------
  function dec2hex(dec){ return ('0' + dec.toString(16)).substr(-2); }
  function generateCodeVerifier(){ const array = new Uint8Array(56); crypto.getRandomValues(array); return Array.from(array, dec2hex).join(''); }
  async function generateCodeChallenge(v){ const data = new TextEncoder().encode(v); const digest = await crypto.subtle.digest('SHA-256', data); return btoa(String.fromCharCode(...new Uint8Array(digest))).replace(/=/g,'').replace(/\+/g,'-').replace(/\//g,'_'); }

  // ---------- Auth / token ----------
  async function startAuth(){
    if(!CLIENT_ID || CLIENT_ID.includes('REPLACE')) { showError('CLIENT_ID not set. Edit the file and set your Spotify Client ID.'); return; }
    const code_verifier = generateCodeVerifier();
    const code_challenge = await generateCodeChallenge(code_verifier);
    const stateVal = Math.random().toString(36).slice(2);
    sessionStorage.setItem('pkce_code_verifier', code_verifier);
    sessionStorage.setItem('pkce_state', stateVal);

    const url = new URL('https://accounts.spotify.com/authorize');
    url.searchParams.set('response_type', 'code');
    url.searchParams.set('client_id', CLIENT_ID);
    url.searchParams.set('scope', SCOPES);
    url.searchParams.set('redirect_uri', REDIRECT_URI);
    url.searchParams.set('state', stateVal);
    url.searchParams.set('code_challenge_method', 'S256');
    url.searchParams.set('code_challenge', code_challenge);

    window.location = url.toString();
  }

  async function exchangeToken(code, code_verifier){
    const body = new URLSearchParams({ grant_type:'authorization_code', code, redirect_uri: REDIRECT_URI, client_id: CLIENT_ID, code_verifier });
    const res = await fetch('https://accounts.spotify.com/api/token', { method:'POST', headers:{ 'Content-Type':'application/x-www-form-urlencoded' }, body: body.toString() });
    if(!res.ok) throw new Error('Token endpoint returned ' + res.status);
    const data = await res.json();
    const now = Date.now();
    localStorage.setItem('sp_access_token', data.access_token);
    localStorage.setItem('sp_refresh_token', data.refresh_token || '');
    localStorage.setItem('sp_token_expires_at', now + (data.expires_in * 1000));
  }

  async function refreshAccessToken(){
    const refresh_token = localStorage.getItem('sp_refresh_token');
    if(!refresh_token) throw new Error('No refresh token available');
    const body = new URLSearchParams({ grant_type:'refresh_token', refresh_token, client_id: CLIENT_ID });
    const res = await fetch('https://accounts.spotify.com/api/token', { method:'POST', headers:{ 'Content-Type':'application/x-www-form-urlencoded' }, body: body.toString() });
    if(!res.ok) throw new Error('Refresh failed: ' + res.status);
    const data = await res.json();
    const now = Date.now();
    localStorage.setItem('sp_access_token', data.access_token);
    localStorage.setItem('sp_token_expires_at', now + (data.expires_in * 1000));
    if(data.refresh_token) localStorage.setItem('sp_refresh_token', data.refresh_token);
  }

  async function getAccessToken(){
    let token = localStorage.getItem('sp_access_token');
    const expires = Number(localStorage.getItem('sp_token_expires_at') || 0);
    if(!token) return null;
    if(Date.now() > expires - 60000){
      try{ await refreshAccessToken(); token = localStorage.getItem('sp_access_token'); } catch(e){ console.warn('refresh failed', e); throw e; }
    }
    return token;
  }

  function logout(){
    ['sp_access_token','sp_refresh_token','sp_token_expires_at'].forEach(k=>localStorage.removeItem(k));
    setStatus('Not logged in','text-amber-300');
    renderMainWelcome();
  }

  // ---------- Spotify API helpers ----------
  async function api(path, opts = {}){
    const token = await getAccessToken();
    if(!token) throw new Error('Not authenticated');
    const url = path.startsWith('http') ? path : ('https://api.spotify.com/v1' + path);
    const res = await fetch(url, { headers: { 'Authorization': 'Bearer ' + token }, ...opts });
    if(res.status === 401){
      await refreshAccessToken();
      const token2 = await getAccessToken();
      const res2 = await fetch(url, { headers: { 'Authorization': 'Bearer ' + token2 }, ...opts });
      if(!res2.ok) throw new Error('Spotify API error: ' + res2.status);
      return res2.json();
    }
    if(!res.ok) throw new Error('Spotify API error: ' + res.status);
    return res.json();
  }
  async function apiNoJson(path, opts = {}){
    const token = await getAccessToken();
    if(!token) throw new Error('Not authenticated');
    const url = path.startsWith('http') ? path : ('https://api.spotify.com/v1' + path);
    return fetch(url, { headers: { 'Authorization': 'Bearer ' + token }, ...opts });
  }

  // ---------- UI helpers ----------
  function pushScreen(renderFn, meta = {}){
    screenStack.push({ renderFn, meta });
    renderFn(meta);
    saveLastState();
  }
  function popScreen(){
    screenStack.pop();
    const top = screenStack[screenStack.length - 1];
    if(top) top.renderFn(top.meta);
    else renderMainMenu();
    saveLastState();
  }
  function renderScreen(html){
    ScreenBody.innerHTML = html;
  }

  // Save/restore last menu & theme & track position
  function saveLastState(){
    try{
      const stateObj = {
        lastStackLen: screenStack.length,
        // save top screen name if available
      };
      localStorage.setItem('ipod_last_state', JSON.stringify({
        theme: settings.theme,
        sensitivity: settings.sensitivity,
        feedback: settings.feedback,
        // list cursor
        listState
      }));
    }catch(e){}
  }
  function restoreLastState(){
    try{
      const raw = localStorage.getItem('ipod_last_state');
      if(!raw) return;
      const s = JSON.parse(raw);
      if(s.theme) { settings.theme = s.theme; localStorage.setItem('ipod_theme', s.theme); applyTheme(); }
      if(s.sensitivity) { settings.sensitivity = s.sensitivity; SCROLL_STEP_ANGLE = SENS_MAP[settings.sensitivity]; localStorage.setItem('ipod_sensitivity', s.sensitivity); }
      if(typeof s.feedback !== 'undefined'){ settings.feedback = s.feedback; localStorage.setItem('ipod_feedback', settings.feedback); }
      if(s.listState) listState = s.listState;
    }catch(e){}
  }

  // ---------- Boot + Status ----------
  function renderBoot(){
    bootScreen.classList.remove('hidden');
    setTimeout(()=> bootScreen.classList.add('hidden'), 850);
  }

  function updateClock(){
    const d = new Date();
    statusBarClock.textContent = d.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
  }
  setInterval(updateClock, 60*1000);
  updateClock();

  if(navigator.getBattery){
    navigator.getBattery().then(bat => {
      function bupd(){ batteryEl.textContent = Math.round(bat.level * 100) + '%'; }
      bupd(); bat.addEventListener('levelchange', bupd);
    });
  } else {
    batteryEl.textContent = '';
  }

  // ---------- Main screens ----------
  function renderMainWelcome(){
    const logged = !!localStorage.getItem('sp_access_token');
    if(!logged){
      renderScreen(`
        <div class="h-full flex flex-col items-center justify-center">
          <div class="text-sm font-semibold mb-3">iPod â€” Spotify Controller</div>
          <button id="loginBtn" class="px-4 py-2 rounded bg-emerald-500 text-slate-900 font-medium">Login with Spotify</button>
          <div class="mt-3 text-xs text-slate-400">Sign in to control Spotify playback</div>
        </div>
      `);
      document.getElementById('loginBtn').addEventListener('click', startAuth);
      setStatus('Not logged in', 'text-amber-300');
    } else {
      renderMainMenu();
      setStatus('Connected', 'text-emerald-400');
    }
  }

  function renderMainMenu(){
    const items = ['Now Playing','Playlists','Search','Library','Devices','Settings'];
    let html = '<div class="h-full overflow-hidden"><div class="space-y-1">';
    items.forEach((m,i)=>{
      html += `<div class="list-item ${i===0? '': ''}" data-i="${i}">${escapeHtml(m)}</div>`;
    });
    html += '</div></div>';
    renderScreen(html);
    setStatus('Ready', 'text-emerald-400');

    // highlight selection via wheel interactions; default selects first
    listState.currentList = items.map((m, i) => ({ name: m }));
    listState.selectedIndex = 0;
    listState.nextUrl = null;
  }

  // Now Playing (compact + full)
  async function renderNowPlaying(){
    try{
      const playback = await api('/me/player');
      if(!playback || !playback.item){
        renderScreen(`<div class="p-3">No music currently playing. Press OK to refresh.</div>`);
        document.getElementById('screenHint').textContent = 'Press OK to refresh';
        return;
      }
      const item = playback.item;
      const artists = item.artists.map(a=>a.name).join(', ');
      const albumArt = (item.album && item.album.images && item.album.images[0]) ? item.album.images[0].url : '';
      const progress = playback.progress_ms || 0;
      const duration = item.duration_ms || 1;
      const pct = Math.round(progress / duration * 100);
      const deviceName = (playback.device && playback.device.name) ? playback.device.name : 'Unknown';
      // show compact + full overlay
      renderScreen(`
        <div class="flex items-center gap-3">
          <img src="${albumArt}" alt="album" class="w-20 h-20 album"/>
          <div>
            <div class="font-semibold">${escapeHtml(item.name)}</div>
            <div class="text-xs muted">${escapeHtml(artists)}</div>
            <div class="text-xs muted mt-1">${escapeHtml(item.album.name)}</div>
            <div class="text-xs muted mt-1">Playing on ${escapeHtml(deviceName)}</div>
          </div>
        </div>
      `);

      // also render full-screen area in a small card (we emulate Now Playing full - accessible via center long-press maybe)
      // but for simplicity the full view is shown if user pushes Now Playing menu (center on Now Playing)
    }catch(e){
      showError(e.message);
    }
  }

  // Playlists & Liked (pagination)
  async function fetchPlaylists(initial=true){
    try{
      if(initial){
        renderScreen('<div class="p-3 loading">Loading playlistsâ€¦</div>');
        listState.currentList = [];
        listState.selectedIndex = 0;
        listState.nextUrl = null;
      }
      const url = listState.nextUrl || '/me/playlists?limit=50';
      const res = await api(url);
      const items = (res.items || []).map(p => ({ id: p.id, name: p.name, tracks: p.tracks.total, uri: p.uri }));
      listState.currentList = listState.currentList.concat(items);
      listState.nextUrl = res.next ? res.next.replace('https://api.spotify.com/v1', '') : null;
      renderList('Your Playlists');
    }catch(e){ showError(e.message); }
  }

  async function fetchLiked(initial=true){
    try{
      if(initial){
        renderScreen('<div class="p-3 loading">Loading liked songsâ€¦</div>');
        listState.currentList = [];
        listState.selectedIndex = 0;
        listState.nextUrl = null;
      }
      const url = listState.nextUrl || '/me/tracks?limit=50';
      const res = await api(url);
      const items = (res.items || []).map(t => ({ id: t.track.id, name: t.track.name, artists: t.track.artists.map(a=>a.name).join(', '), uri: t.track.uri }));
      listState.currentList = listState.currentList.concat(items);
      listState.nextUrl = res.next ? res.next.replace('https://api.spotify.com/v1', '') : null;
      renderList('Liked Songs');
    }catch(e){ showError(e.message); }
  }

  function renderList(title){
    const items = listState.currentList.map((it,i) => `<div class="list-item ${i===listState.selectedIndex?'selected':''}" data-i="${i}">${escapeHtml(it.name)} ${it.artists?'<div class="text-xs muted">'+escapeHtml(it.artists)+'</div>':''}</div>`).join('');
    const more = listState.nextUrl ? '<div class="p-2 text-xs muted">Scroll to bottom to load more...</div>' : '';
    renderScreen(`<div class="h-full flex flex-col"><div class="text-xs muted mb-2">${escapeHtml(title)}</div><div id="listScroll" class="overflow-auto" style="max-height:100%">${items}${more}</div></div>`);
    const scrollEl = document.getElementById('listScroll');
    scrollEl.addEventListener('click', ev => {
      const node = ev.target.closest('[data-i]');
      if(!node) return;
      listState.selectedIndex = Number(node.dataset.i);
      listSelect();
    });
  }

  async function fetchPlaylistTracks(playlistId, playlistName){
    try{
      renderScreen('<div class="p-3 loading">Loading playlist tracksâ€¦</div>');
      const data = await api(`/playlists/${playlistId}/tracks?limit=100`);
      const items = (data.items || []).map(i => ({ name: i.track.name, artists: i.track.artists.map(a=>a.name).join(', '), uri: i.track.uri }));
      listState.currentList = items;
      listState.selectedIndex = 0;
      listState.nextUrl = null;
      renderList(playlistName);
    }catch(e){ showError(e.message); }
  }

  async function playUri(uri){
    try{
      const body = JSON.stringify({
        uris: uri && uri.startsWith('spotify:track:') ? [uri] : undefined,
        context_uri: uri && (uri.startsWith('spotify:playlist:') || uri.startsWith('spotify:album:')) ? uri : undefined
      });
      const res = await apiNoJson('/me/player/play', { method:'PUT', body });
      if(res.status === 404) showError('No active device found. Open Spotify on a device and try again.');
      else if(res.status >= 400) showError('Playback failed: ' + res.status);
      else pushScreen(renderNowPlaying);
    }catch(e){ showError(e.message); }
  }

  // ---------- Devices ----------
  async function renderDevices(){
    try{
      renderScreen('<div class="p-3 loading">Loading devicesâ€¦</div>');
      const data = await api('/me/player/devices');
      const devices = data.devices || [];
      if(devices.length === 0){ renderScreen('<div class="p-3">No devices found. Open Spotify on a device and try again.</div>'); return; }
      listState.currentList = devices.map(d => ({ id: d.id, name: d.name, type: d.type, is_active: d.is_active }));
      listState.selectedIndex = 0;
      let html = `<div class="text-xs muted mb-2">Available Devices</div><div id="deviceList" class="overflow-auto">`;
      html += listState.currentList.map((d,i) => `<div class="list-item ${d.is_active? 'selected':''}" data-i="${i}">${escapeHtml(d.name)}<div class="text-xs muted">${escapeHtml(d.type)}</div></div>`).join('');
      html += '</div>';
      renderScreen(html);
      document.getElementById('deviceList').addEventListener('click', async ev => {
        const node = ev.target.closest('[data-i]');
        if(!node) return;
        const idx = Number(node.dataset.i);
        const dev = listState.currentList[idx];
        try{
          await apiNoJson('/me/player', { method:'PUT', body: JSON.stringify({ device_ids: [dev.id], play: true }) });
          setStatus('Transferred to ' + dev.name, 'text-emerald-400');
          await renderNowPlaying();
        }catch(err){ showError(err.message); }
      });
    }catch(e){ showError(e.message); }
  }

  // ---------- Search ----------
  function renderSearch(){
    renderScreen(`
      <div class="h-full flex flex-col">
        <div class="text-xs muted mb-2">Search Spotify</div>
        <input id="searchInput" class="w-full p-2 rounded bg-slate-700 text-sm" placeholder="Type query and press OK"/>
        <div class="text-xs muted mt-2">Use wheel to move results â€¢ OK to play/open</div>
      </div>
    `);
    const input = document.getElementById('searchInput');
    input.focus();
    // pressing Enter triggers search (OK center does the same, handled in center click)
    input.addEventListener('keydown', async ev => {
      if(ev.key === 'Enter') await doSearch(input.value);
    });
  }

  async function doSearch(query){
    if(!query || !query.trim()) return;
    renderScreen('<div class="p-3 loading">Searchingâ€¦</div>');
    try{
      const res = await api(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track,artist,album,playlist&limit=20`);
      const items = [];
      (res.tracks?.items || []).forEach(t => items.push({ type: 'track', name: t.name, artists: t.artists.map(a=>a.name).join(', '), uri: t.uri }));
      (res.albums?.items || []).forEach(a => items.push({ type: 'album', name: a.name, artists: a.artists.map(ar => ar.name).join(', '), uri: a.uri }));
      (res.artists?.items || []).forEach(a => items.push({ type: 'artist', name: a.name, uri: a.uri }));
      (res.playlists?.items || []).forEach(p => items.push({ type: 'playlist', name: p.name, uri: p.uri }));
      listState.currentList = items;
      listState.selectedIndex = 0;
      listState.nextUrl = null;
      renderList('Search Results');
    }catch(e){ showError(e.message); }
  }

  // ---------- Settings ----------
  function renderSettings(){
    renderScreen(`
      <div class="h-full flex flex-col">
        <div class="text-xs muted mb-2">Settings</div>
        <div class="space-y-2">
          <div class="list-item" data-action="theme">Theme</div>
          <div class="list-item" data-action="sensitivity">Wheel Sensitivity</div>
          <div class="list-item" data-action="feedback">Feedback</div>
          <div class="list-item" data-action="logout">Logout</div>
        </div>
      </div>
    `);
    ScreenBody.querySelector('[data-action="theme"]').addEventListener('click', renderThemeMenu);
    ScreenBody.querySelector('[data-action="sensitivity"]').addEventListener('click', renderSensitivityMenu);
    ScreenBody.querySelector('[data-action="feedback"]').addEventListener('click', renderFeedbackMenu);
    ScreenBody.querySelector('[data-action="logout"]').addEventListener('click', logout);
  }

  function renderThemeMenu(){
    renderScreen(`
      <div class="h-full flex flex-col">
        <div class="text-xs muted mb-2">Theme</div>
        <div class="space-y-2">
          <div class="list-item ${settings.theme==='classic'?'selected':''}" data-theme="classic">Classic White/Gray</div>
          <div class="list-item ${settings.theme==='black'?'selected':''}" data-theme="black">U2 Black/Red</div>
          <div class="list-item ${settings.theme==='mini-blue'?'selected':''}" data-theme="mini-blue">Mini Blue</div>
          <div class="list-item ${settings.theme==='mini-pink'?'selected':''}" data-theme="mini-pink">Mini Pink</div>
          <div class="list-item ${settings.theme==='mini-green'?'selected':''}" data-theme="mini-green">Mini Green</div>
          <div class="list-item ${settings.theme==='color'?'selected':''}" data-theme="color">Color Screen</div>
        </div>
      </div>
    `);
    Array.from(ScreenBody.querySelectorAll('[data-theme]')).forEach(el => el.addEventListener('click', e => {
      const t = e.currentTarget.dataset.theme;
      settings.theme = t;
      localStorage.setItem('ipod_theme', t);
      applyTheme();
      renderSettings();
    }));
  }

  function renderSensitivityMenu(){
    renderScreen(`
      <div class="h-full flex flex-col">
        <div class="text-xs muted mb-2">Wheel Sensitivity</div>
        <div class="space-y-2">
          <div class="list-item ${settings.sensitivity==='low'?'selected':''}" data-s="low">Low</div>
          <div class="list-item ${settings.sensitivity==='medium'?'selected':''}" data-s="medium">Medium</div>
          <div class="list-item ${settings.sensitivity==='high'?'selected':''}" data-s="high">High</div>
        </div>
      </div>
    `);
    Array.from(ScreenBody.querySelectorAll('[data-s]')).forEach(el => el.addEventListener('click', e => {
      settings.sensitivity = e.currentTarget.dataset.s;
      localStorage.setItem('ipod_sensitivity', settings.sensitivity);
      SCROLL_STEP_ANGLE = SENS_MAP[settings.sensitivity];
      renderSettings();
    }));
  }

  function renderFeedbackMenu(){
    renderScreen(`
      <div class="h-full flex flex-col">
        <div class="text-xs muted mb-2">Feedback</div>
        <div class="space-y-2">
          <div class="list-item ${settings.feedback ? 'selected':''}" data-f="on">Enabled</div>
          <div class="list-item ${!settings.feedback ? 'selected':''}" data-f="off">Disabled</div>
        </div>
      </div>
    `);
    Array.from(ScreenBody.querySelectorAll('[data-f]')).forEach(el => el.addEventListener('click', e => {
      const v = e.currentTarget.dataset.f === 'on';
      settings.feedback = v;
      localStorage.setItem('ipod_feedback', v);
      renderSettings();
    }));
  }

  function applyTheme(){
    const root = document.getElementById('ipodInner').parentElement; // ipod root with theme class
    // remove existing theme classes
    root.classList.remove('theme-classic','theme-black','theme-mini-blue','theme-mini-pink','theme-mini-green','theme-color');
    // apply chosen
    if(settings.theme === 'classic') root.classList.add('theme-classic');
    if(settings.theme === 'black') root.classList.add('theme-black');
    if(settings.theme === 'mini-blue') root.classList.add('theme-mini-blue');
    if(settings.theme === 'mini-pink') root.classList.add('theme-mini-blue'); // mapping similar visuals
    if(settings.theme === 'mini-green') root.classList.add('theme-mini-blue');
    if(settings.theme === 'color') root.classList.add('theme-mini-blue');
  }
  applyTheme();

  // ---------- Wheel interaction (circular gesture) ----------
  const wheelEl = document.getElementById('wheel');
  let wheelActive = false, lastAngle = null, accumulated = 0;
  const STEP_ANGLE = () => SCROLL_STEP_ANGLE;

  function getAngleFromEvent(e){
    const rect = wheelEl.getBoundingClientRect();
    const cx = rect.left + rect.width/2;
    const cy = rect.top + rect.height/2;
    const x = (e.clientX ?? (e.touches && e.touches[0].clientX)) - cx;
    const y = (e.clientY ?? (e.touches && e.touches[0].clientY)) - cy;
    const angle = Math.atan2(y, x) * 180 / Math.PI;
    return (angle + 360) % 360;
  }

  function onPointerDown(e){
    e.preventDefault();
    wheelActive = true;
    lastAngle = getAngleFromEvent(e);
    accumulated = 0;
  }
  function onPointerMove(e){
    if(!wheelActive) return;
    e.preventDefault();
    const ang = getAngleFromEvent(e);
    let delta = ang - lastAngle;
    if(delta > 180) delta -= 360;
    if(delta < -180) delta += 360;
    accumulated += delta;
    lastAngle = ang;
    if(Math.abs(accumulated) >= STEP_ANGLE()){
      const steps = Math.floor(Math.abs(accumulated) / STEP_ANGLE());
      const dir = accumulated > 0 ? 1 : -1; // clockwise increases
      for(let i=0;i<steps;i++) handleWheelScroll(dir);
      accumulated = accumulated % STEP_ANGLE();
    }
  }
  function onPointerUp(e){
    wheelActive = false;
    lastAngle = null;
    accumulated = 0;
  }

  async function handleWheelScroll(dir){
    // feedback
    playTick();
    // context-aware
    const top = screenStack[screenStack.length - 1];
    if(!top){ // on main menu / default
      // For main menu, move a virtual index
      if(listState.currentList.length){
        listState.selectedIndex = (listState.selectedIndex + dir + listState.currentList.length) % listState.currentList.length;
        // if main menu items are simple strings, reflect by re-rendering main menu
        // we'll re-render the visible list if it was rendered by renderList
        // best-effort: if current view is list-based, re-render list
        if(document.getElementById('listScroll')) renderList('');
      } else {
        // no list, just re-render main menu as selection moved
        renderMainMenu();
      }
    } else if(top.renderFn === renderList){
      // move selection in rendered list
      listState.selectedIndex = (listState.selectedIndex + dir + (listState.currentList.length || 1)) % (listState.currentList.length || 1);
      renderList('');
      // if at end and nextPage exists, fetch more
      if(listState.selectedIndex >= (listState.currentList.length - 1) && listState.nextUrl) {
        try{ await fetchNextListPage(); }catch(e){ console.warn(e); }
      }
    } else if(top.renderFn === renderNowPlaying){
      // adjust volume
      try{
        const playback = await api('/me/player');
        const vol = (playback && playback.device && playback.device.volume_percent) ? playback.device.volume_percent : 50;
        const nv = Math.max(0, Math.min(100, vol + dir * 2));
        await setVolume(nv);
      }catch(e){ showError(e.message); }
    } else {
      // default
      // move menu index
      listState.selectedIndex = (listState.selectedIndex + dir + (listState.currentList.length || 1)) % (listState.currentList.length || 1);
      renderList('');
    }
  }

  // wheel event listeners
  wheelEl.addEventListener('pointerdown', onPointerDown);
  window.addEventListener('pointermove', onPointerMove);
  window.addEventListener('pointerup', onPointerUp);
  wheelEl.addEventListener('touchstart', onPointerDown, { passive:false });
  wheelEl.addEventListener('touchmove', onPointerMove, { passive:false });
  window.addEventListener('touchend', onPointerUp);

  // ---------- Buttons ----------
  const centerBtn = document.getElementById('centerBtn');
  document.getElementById('menuBtn').parentElement.addEventListener('click', () => {
    popScreen();
  });

  document.getElementById('prevBtn').parentElement.addEventListener('click', () => prevTrack());
  document.getElementById('nextBtn').parentElement.addEventListener('click', () => nextTrack());
  document.getElementById('playBtn').parentElement.addEventListener('click', () => togglePlayPause());

  // center click behavior (select)
  centerBtn.addEventListener('click', async () => {
    // quick press = select; long press could open context (not fully implemented for space)
    const top = screenStack[screenStack.length - 1];
    if(!top){
      // main menu default: select item 0 => Now Playing
      // we'll branch based on listState.currentList if it's main menu
      // If the user is seeing a menu as list, select the selected item
      const visible = listState.currentList[ listState.selectedIndex ];
      if(visible && visible.name){
        // if it's one of main items (Now Playing, Playlists, etc)
        const name = visible.name || visible;
        if(name === 'Now Playing') pushScreen(renderNowPlaying);
        else if(name === 'Playlists') { await fetchPlaylists(true); pushScreen(() => renderList('Your Playlists')); }
        else if(name === 'Search') { pushScreen(renderSearch); renderSearch(); }
        else if(name === 'Library') { await fetchLiked(true); pushScreen(() => renderList('Liked Songs')); }
        else if(name === 'Devices') { await renderDevices(); pushScreen(renderDevices); }
        else if(name === 'Settings') { pushScreen(renderSettings); renderSettings(); }
        else { /* fallback */ }
      } else {
        // fallback: show main menu
        renderMainMenu();
      }
    } else if(top.renderFn === renderList){
      await listSelect();
    } else if(top.renderFn === renderNowPlaying){
      await togglePlayPause();
    }
    // tiny visual pressed state
    centerBtn.classList.add('pressed');
    setTimeout(()=>centerBtn.classList.remove('pressed'), 80);
  });

  // keyboard shortcuts for accessibility (and quick testing)
  window.addEventListener('keydown', (e) => {
    if(e.key === 'ArrowUp') handleWheelScroll(-1);
    if(e.key === 'ArrowDown') handleWheelScroll(1);
    if(e.key === 'ArrowLeft') prevTrack();
    if(e.key === 'ArrowRight') nextTrack();
    if(e.key === 'Enter') centerBtn.click();
    if(e.key === 'Backspace') document.getElementById('menuBtn').parentElement.click();
    if(e.key === 's' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); pushScreen(renderSearch); renderSearch(); }
  });

  // ---------- List Select / Play ----------
  async function listSelect(){
    const item = listState.currentList[listState.selectedIndex];
    if(!item) return;
    if(item.tracks !== undefined){ // playlist
      await fetchPlaylistTracks(item.id, item.name);
      pushScreen(()=>renderList(item.name));
    } else if(item.type === 'album'){
      try{
        const id = item.uri.split(':').pop();
        const tracks = await api(`/albums/${id}/tracks?limit=50`);
        listState.currentList = tracks.items.map(t => ({ name: t.name, artists: t.artists.map(a=>a.name).join(', '), uri: t.uri }));
        listState.selectedIndex = 0;
        listState.nextUrl = null;
        renderList(item.name);
      }catch(e){ showError(e.message); }
    } else if(item.type === 'artist'){
      try{
        const id = item.uri.split(':').pop();
        const top = await api(`/artists/${id}/top-tracks?market=US`);
        listState.currentList = top.tracks.map(t => ({ name: t.name, artists: t.artists.map(a=>a.name).join(', '), uri: t.uri }));
        listState.selectedIndex = 0;
        listState.nextUrl = null;
        renderList('Top tracks');
      }catch(e){ showError(e.message); }
    } else {
      // assume track
      try{ await playUri(item.uri); pushScreen(renderNowPlaying); }catch(e){ showError(e.message); }
    }
  }

  async function fetchNextListPage(){
    if(!listState.nextUrl) return;
    const url = listState.nextUrl;
    const res = await api(url);
    const items = (res.items || []).map(i => {
      const t = i.track || i;
      return { name: t.name, artists: t.artists ? t.artists.map(a=>a.name).join(', ') : undefined, uri: t.uri };
    });
    listState.currentList = listState.currentList.concat(items);
    listState.nextUrl = res.next ? res.next.replace('https://api.spotify.com/v1','') : null;
    renderList('');
  }

  // ---------- Playback control ----------
  async function togglePlayPause(){
    try{
      const playback = await api('/me/player');
      if(!playback) return;
      if(playback.is_playing) await apiNoJson('/me/player/pause', { method:'PUT' });
      else await apiNoJson('/me/player/play', { method:'PUT' });
      await renderNowPlaying();
    }catch(e){ showError(e.message); }
  }
  async function nextTrack(){
    try{ await apiNoJson('/me/player/next', { method:'POST' }); await renderNowPlaying(); }catch(e){ showError(e.message); }
  }
  async function prevTrack(){
    try{ await apiNoJson('/me/player/previous', { method:'POST' }); await renderNowPlaying(); }catch(e){ showError(e.message); }
  }
  async function setVolume(percent){
    try{
      await apiNoJson(`/me/player/volume?volume_percent=${Math.max(0, Math.min(100, percent))}`, { method:'PUT' });
      showVolumeOverlay(percent);
      setStatus('Volume ' + percent + '%', 'text-emerald-400');
    }catch(e){ showError(e.message); }
  }

  // Volume overlay
  let volTimeout = null;
  function showVolumeOverlay(percent){
    const existing = document.getElementById('volOverlay');
    if(existing) existing.remove();
    const div = document.createElement('div');
    div.id = 'volOverlay';
    div.className = 'volume-overlay';
    div.innerHTML = `<div class="text-sm font-semibold">${percent}%</div><div class="w-48 h-3 bg-slate-700 rounded overflow-hidden mt-2"><div style="width:${percent}%" class="h-full bg-emerald-400"></div></div>`;
    ipodRoot.appendChild(div);
    if(volTimeout) clearTimeout(volTimeout);
    volTimeout = setTimeout(()=>{ div.remove(); }, 1200);
  }

  // ---------- Feedback (tick + vibration) ----------
  function playTick(){
    try{
      if(settings.feedback){
        if(navigator.vibrate) navigator.vibrate(6);
        if(tickAudio){ tickAudio.volume = 0.04; tickAudio.currentTime = 0; tickAudio.play().catch(()=>{}); }
      }
    }catch(e){}
  }

  // ---------- Redirect handling ----------
  async function handleRedirectCallback(){
    const params = qsParse(location.search);
    if(params.error){ showError(params.error); return; }
    if(params.code){
      const stateVal = params.state;
      const saved = sessionStorage.getItem('pkce_state');
      if(stateVal !== saved){ showError('State mismatch'); return; }
      const code = params.code;
      const code_verifier = sessionStorage.getItem('pkce_code_verifier');
      try{
        await exchangeToken(code, code_verifier);
        // clear url query
        history.replaceState({}, document.title, REDIRECT_URI);
        initApp();
      }catch(e){ showError('Token exchange failed: ' + e.message); }
    }
  }

  // ---------- Silent login on load ----------
  async function initApp(){
    try{
      renderBoot();
      restoreLastState();
      if(localStorage.getItem('sp_refresh_token')){
        try{
          await refreshAccessToken();
          setStatus('Connected', 'text-emerald-400');
          await renderNowPlaying();
          return;
        }catch(e){
          console.warn('Silent refresh failed', e);
        }
      }
      const token = await getAccessToken().catch(()=>null);
      if(token){ setStatus('Connected', 'text-emerald-400'); await renderNowPlaying(); }
      else renderMainWelcome();
    }catch(e){ showError(e.message); }
  }

  // ---------- Service worker (inline blob) ----------
  if('serviceWorker' in navigator){
    try{
      const swCode = `
        const CACHE_NAME = 'ipod-shell-v5';
        const ASSETS = ['./','./index.html'];
        self.addEventListener('install', e => {
          e.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(ASSETS)));
          self.skipWaiting();
        });
        self.addEventListener('fetch', event => {
          const url = new URL(event.request.url);
          if(url.origin === location.origin){
            event.respondWith(caches.match(event.request).then(r => r || fetch(event.request)));
          }
        });
      `;
      const blob = new Blob([swCode], { type: 'application/javascript' });
      const swUrl = URL.createObjectURL(blob);
      navigator.serviceWorker.register(swUrl).then(()=>console.log('Service worker registered')).catch(()=>{});
    }catch(e){ console.warn('SW failed', e); }
  }

  // ---------- Misc small helpers ----------
  function formatMs(ms){
    const s = Math.floor(ms / 1000);
    const m = Math.floor(s / 60);
    const sec = s % 60;
    return m + ':' + (sec < 10 ? '0' : '') + sec;
  }

  // ---------- Start ----------
  (async () => {
    await handleRedirectCallback();
    await initApp();
  })();

  // expose for debugging
  window._ipod = { startAuth, logout, getAccessToken };

  </script>
</body>
</html>

